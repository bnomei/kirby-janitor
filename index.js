(function(){"use strict";function k(e,t,o,a,n,h,r,l){var s=typeof e=="function"?e.options:e;return t&&(s.render=t,s.staticRenderFns=o,s._compiled=!0),{exports:e,options:s}}const i="janitor.runAfterAutosave",C={props:{autosave:Boolean,backgroundColor:String,clipboard:Boolean,color:String,confirm:String,command:String,cooldown:Number,error:String,icon:String,intab:Boolean,help:String,label:String,headline:String,progress:String,success:String,status:String,unsaved:Boolean},data(){return{button:{label:null,state:null,headline:null,help:null,style:null},clipboardRequest:null,downloadRequest:null,icons:{"is-running":"janitorLoader","is-success":"check","has-error":"alert"},isUnsaved:!1,urlRequest:null}},computed:{buttonStyle(){return this.button.style||{color:this.color,backgroundColor:this.backgroundColor}},currentIcon(){return this.icons[this.status]??this.icon},id(){return"janitor-"+this.hashCode(this.command+(this.button.label??"")+this.label)},hasChanges(){return Object.keys(this.$panel.content.diff()).length>0}},created(){this.eventHandler=()=>sessionStorage.getItem(i)&&location.reload(),window.panel.events.on("model.update",this.eventHandler),sessionStorage.getItem(i)===this.id&&(sessionStorage.removeItem(i),this.runJanitor())},unmounted(){window.panel.events.off("model.update",this.eventHandler)},methods:{hashCode(e){let t=0;if(e.length===0)return t;for(const o of e)t=(t<<5)-t+e.charCodeAt(o),t=t&t;return t},async runJanitor(){if(!(this.confirm&&!window.confirm(this.confirm))){if(this.autosave&&this.hasChanges){const e=document.querySelector(".k-panel .k-header-buttons .k-form-controls button:nth-child(2)");if(e){this.isUnsaved=!1,sessionStorage.setItem(i,this.id),this.simulateClick(e);return}}if(this.clipboardRequest){await this.copyToClipboard(this.clipboardRequest),this.resetButton(),this.clipboardRequest=null;return}this.status||await this.postRequest("plugin-janitor",{command:this.command,path:window.location.pathname})}},async postRequest(e,t){this.button.label=this.progress??`${this.label} â€¦`,this.button.state="is-running";const{label:o,message:a,status:n,reload:h,open:r,download:l,clipboard:s,success:_,icon:d,headline:b,help:f,color:p,backgroundColor:m,resetStyle:g,notification:w,error:u,warn:v,log:y}=await this.$api.post(e,t);if(n===200?this.button.label=_??this.success:this.button.label=u??this.error,o&&(this.label=o),a&&(this.button.label=a),f&&(this.button.help=f),b&&(this.button.headline=b),d&&(this.icon=d),this.button.style={color:"white",reset:!0},n?(this.button.state=n===200?"is-success":"has-error",this.button.style.backgroundColor=n===200?"var(--color-positive)":"var(--color-negative-light)"):this.button.state="has-response",p&&(this.button.style.reset=!1,this.button.style.color=p),m&&(this.button.style.reset=!1,this.button.style.backgroundColor=m),g&&(this.button.style.reset=g),w){let[x,T]=w;window.panel.notification[x](T)}u&&console.error(u),v&&console.warn(v),y&&console.log(y),h&&setTimeout(()=>location.reload(),this.cooldown||0),r&&(this.intab?(this.urlRequest=r,this.$nextTick(()=>{this.simulateClick(this.$refs.tabAnchor)})):location.href=r),l&&(this.downloadRequest=l,this.$nextTick(()=>{this.simulateClick(this.$refs.downloadAnchor)})),s?(this.clipboardRequest=s,this.button.label=this.progress,this.button.state="is-success",setTimeout(this.resetButton,this.cooldown),this.$nextTick(()=>{this.copyToClipboard(this.clipboardRequest)})):setTimeout(this.resetButton,this.cooldown||2e3)},resetButton(){var e;this.button.label=null,this.button.state=null,this.button.style=(e=this.button.style)!=null&&e.reset?null:this.button.style},simulateClick(e){const t=new MouseEvent("click",{bubbles:!0,cancelable:!0,view:window});e.dispatchEvent(t)},copyToClipboardWithTextarea(e){const t=document.createElement("textarea");t.value=e,t.style.position="absolute",t.style.left="-999999px",document.body.prepend(t),t.select();try{document.execCommand("copy")===!1&&console.error("Using `navigator.clipboard` did not work most likely due to the Kirby Panel running on localhost or no https. Janitor then tried to copy with a textarea but that failed as well.")}catch(o){console.error(o)}finally{t.remove()}},async copyToClipboard(e){try{await navigator.clipboard.writeText(e)}catch(t){console.error(t),this.copyToClipboardWithTextarea(e)}}}};var S=function(){var t=this,o=t._self._c;return o("k-field",{staticClass:"janitor-wrapper",attrs:{label:t.button.headline||t.headline,help:t.button.help||t.help}},[o("k-button",{class:["k-button janitor",t.button.state],style:t.buttonStyle,attrs:{id:t.id,icon:t.currentIcon,command:t.command,disabled:!t.unsaved&&!t.isUnsaved&&t.hasChanges,variant:"filled"},on:{click:t.runJanitor}},[t._v(" "+t._s(t.button.label||t.label)+" ")]),o("a",{directives:[{name:"show",rawName:"v-show",value:t.downloadRequest,expression:"downloadRequest"}],ref:"downloadAnchor",staticClass:"visually-hidden",attrs:{href:t.downloadRequest,download:""}}),o("a",{directives:[{name:"show",rawName:"v-show",value:t.urlRequest,expression:"urlRequest"}],ref:"tabAnchor",staticClass:"visually-hidden",attrs:{href:t.urlRequest,target:"_blank"}})],1)},R=[],q=k(C,S,R);const c=q.exports;window.panel.plugin("bnomei/janitor",{fields:{janitor:c},viewButtons:{janitor:c},icons:{janitorLoader:'<svg viewBox="0 0 24 24" version="1.1" id="svg2" xmlns="http://www.w3.org/2000/svg" xmlns:svg="http://www.w3.org/2000/svg"><g fill="none" fill-rule="evenodd" id="g2" transform="matrix(1.2373578,0,0,1.2393776,2.1011378,2.0846672)"><g transform="translate(1,1)" stroke-width="1.75" id="g1"><circle cx="7" cy="7" r="7.2" stroke="#000" stroke-opacity=".2" id="circle1"/><path d="M 14.2,7 C 14.2,3 11,-0.2 7,-0.2" stroke="#000" id="path1"><animateTransform attributeName="transform" type="rotate" from="0 7 7" to="360 7 7" dur="1s" repeatCount="indefinite"/></path></g></g></svg>'}})})();
